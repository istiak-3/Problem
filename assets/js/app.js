$(document).ready(function () {
    // Create the indicator element once
    const $stretchyIndicator = $('<div class="stretchy-indicator"></div>');
    // Cache the standard transition string for easy toggling
    const TRANSITION_STRING = 'left 0.4s cubic-bezier(0.5, 0, 0.5, 1), width 0.4s cubic-bezier(0.5, 0, 0.5, 1)';


    // 1. Initialize Slick Slider Setup
    $('.cardRow').on('init', function (event, slick) {
        const $slider = $(this);

        // Set up the dots area and append the custom indicator
        $slider.find('.slick-dots').wrap('<div class="slick-dots-wrapper"></div>');
        // The indicator must be appended to the list of dots to get correct positioning context
        $slider.find('.slick-dots').append($stretchyIndicator);

        // Get the position of the first dot to initialize the indicator
        const $initialDot = $slider.find('.slick-dots li').eq(0);

        if ($initialDot.length) {
            const dotOffset = $initialDot.position().left;
            const dotWidth = $initialDot.outerWidth();

            // Set indicator to the first dot's position and size
            $stretchyIndicator.css({
                width: dotWidth + 'px',
                left: dotOffset + 'px',
            });

            // NEW: Ensure the very first dot is bright on load
            $initialDot.addClass('dot-bright');
        }

        // Clear the default button text generated by Slick
        $slider.find("ul.slick-dots li button").text("");
    });

    // Initialize Slick Carousel
    $('.cardRow').slick({
        infinite: true,
        dots: true,
        slidesToShow: 1,
        slidesToScroll: 1,
        speed: 600,
        centerMode: true,
        centerPadding: 0,
        arrows: true,
        prevArrow: ".arrowLeft",
        nextArrow: ".arrowRight",
        draggable: true,
    });

    // 2. Core Logic Phase 1: STRETCH and MOVE (Before Change)
    $('.cardRow').on('beforeChange', function (event, slick, currentSlide, nextSlide) {
        const currentDotIndex = currentSlide;

        // Find the DOM elements for the current dot and the target dot
        const $currentDot = $(this).find('.slick-dots li').eq(currentDotIndex);
        const $targetDot = $(this).find('.slick-dots li').eq(nextSlide);

        if ($targetDot.length && $currentDot.length) {
            const $indicator = $('.stretchy-indicator');
            const currentOffset = $currentDot.position().left;
            const dotWidth = $currentDot.outerWidth();

            // KEY: Keep the starting dot bright during the slide transition
            $currentDot.addClass('dot-bright');

            // --- CRITICAL FIX: SNAP TO START ---
            // 1. Instantly snap the indicator to the exact previous dot's position (no transition)
            $indicator.css('transition', 'none');
            $indicator.css({
                width: dotWidth + 'px',
                left: currentOffset + 'px',
            });

            // 2. Force the browser to repaint (reflow) immediately to apply the snap
            $indicator[0].offsetHeight;

            // 3. Re-enable the transition for the stretch phase
            $indicator.css('transition', TRANSITION_STRING);
            // --- CRITICAL FIX END ---

            // Now calculate the STRETCH target state (Phase 1)
            const targetOffset = $targetDot.position().left;

            // Calculate the start (left) and end (right) points of the stretch
            const stretchLeft = Math.min(currentOffset, targetOffset);
            const stretchRight = Math.max(currentOffset, targetOffset) + dotWidth;

            // Calculate the full width the indicator needs to cover
            const stretchWidth = stretchRight - stretchLeft;

            // Apply the stretched state. The transition is now active and will animate this change.
            $indicator.css({
                width: stretchWidth + 'px',
                left: stretchLeft + 'px',
            });
        }
    });

    // 3. Core Logic Phase 2: SHRINK and SETTLE (After Change)
    $('.cardRow').on('afterChange', function (event, slick) {
        const $slider = $(this);
        const newActiveSlideIndex = slick.currentSlide;
        const $activeDot = $slider.find('.slick-dots li').eq(newActiveSlideIndex);
        const $indicator = $('.stretchy-indicator');

        // 1. Clean up: Remove the bright class from ALL dots (including the one we just left)
        $slider.find('.slick-dots li').removeClass('dot-bright');

        // 2. KEY: Make the new destination dot bright only AFTER the indicator has finished moving and shrinking
        if ($activeDot.length) {
            $activeDot.addClass('dot-bright');

            // Get the final position and size
            const dotOffset = $activeDot.position().left;
            const dotWidth = $activeDot.outerWidth();

            // Apply the final settled state (CSS transition handles the smooth shrink)
            $indicator.css('transition', TRANSITION_STRING);
            $indicator.css({
                width: dotWidth + 'px',
                left: dotOffset + 'px',
            });
        }
    });

});